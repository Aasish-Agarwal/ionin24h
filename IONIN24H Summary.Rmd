---
title: "IONIN24H Summary"
author: "Aasish Agarwal"
date: "July 31, 2015"
---
# Prerequisites

This script assumes that data for analysis is stored under `data\sessions` folder.

* Create a folder named `<yyyymm>` under sessions folder - `Working Folder`
* Download the contacts from `ION Tracker` and save them as `ion_contacts.csv` in `Working Folder`
* Create `voters.csv` in `Working Folder` from the responses recieved for this session. Only include the `Username` column
* Create `team_groups.csv` in `Working Folder` capturing the relationship of a team with area, so that we can produce area wise summary. Having columns `team	and area`. 
* * Example `anvil9ba,	Anvil`
* Create `innovators.csv` in `Working Folder` listing email of all members that presented their projects. Column must have the header `email`

# Preparing data set
```{r,results='hide'}
library(dplyr)
session <- "201506"


# Prepare Participant Structure
## Browse through the list of teams
## Create a data frame with mail id and mailing list name


mailinglistpath = paste("data/sessions" , session , "teams", sep = "/")
files <- list.files(path=mailinglistpath, pattern="*.txt", full.names=T, recursive=FALSE)

mailing_lists <- do.call(rbind,lapply(files, function(x) {
  listname <- sub("@.*", "", basename(x))
  members <- read.csv(x,stringsAsFactors = F, na.strings=c("NA","NaN", "") , header = F) %>%
    tbl_df() %>%
    filter( !is.na(V1) ) %>%
    mutate(email = sub(".*<", "", V1), email = sub(">.*","",email),team = listname)  %>%
    mutate(email = tolower(email))  %>%
    select(email,team)
  })
)


# load team groups
filename = paste("data/sessions" , session , "team_groups.csv", sep = "/")
team_groups <- read.csv(filename,stringsAsFactors = F, na.strings=c("NA","NaN", "") ) %>%
  tbl_df()


# load innovators
filename = paste("data/sessions" , session , "innovators.csv", sep = "/")
innovators <- read.csv(filename,stringsAsFactors = F, na.strings=c("NA","NaN", "") ) %>%
  tbl_df() %>%
  mutate(email = tolower(email), innovated = 1)  %>%
  unique()


# Prepare voters list
filename = paste("data/sessions" , session , "voters.csv", sep = "/")
voters <- read.csv(filename,stringsAsFactors = F, na.strings=c("NA","NaN", "") ) %>%
  tbl_df() %>%
  rename(email = Username) %>%
  select(email) %>%
  filter( !is.na(email) ) %>%
  mutate(email = tolower(email), voted = 1) 


# Create the data frame with mail, Location, Team, Group
## Read the contacts file
filename = paste("data/sessions" , session , "ion_contacts.csv", sep = "/")
ion_contacts <- read.csv(filename,stringsAsFactors = F, na.strings=c("NA","NaN", "") ) %>%
  tbl_df() %>%
  rename(email = E.mail.Address , location = Office.Location) %>%
  select(email,location,Company,Department) %>%
  filter( !is.na(email) ) %>%
  mutate(email = tolower(email))  

# Now join mailing_lists, voters, ion_contacts
report_df <- merge(mailing_lists, voters, by="email", all.x=TRUE) %>% tbl_df()
report_df <- merge(report_df, ion_contacts, by="email", all.x=TRUE) %>% tbl_df()
report_df <- merge(report_df, team_groups, by="team", all.x=TRUE) %>% tbl_df()
report_df <- merge(report_df, innovators, by="email", all.x=TRUE) %>% tbl_df()

report_df$innovated = replace(report_df$innovated, is.na(report_df$innovated), 0)

report_df$voted = replace(report_df$voted, is.na(report_df$voted), 0)
```

```{r}
#mailing_lists
#voters
#ion_contacts
```


# Participation By Location

```{r}
report_df_for_location <- report_df %>%
  select(email,voted,location) %>%
  filter( !is.na(location) ) %>%
  unique()

voting_by_location <- report_df_for_location %>%
  group_by(location) %>%
  summarize(count = n(), total = sum(voted), pct  = round((total/count)*100,0)) %>%
  filter(pct > 0)

voting_by_location <- voting_by_location[order(voting_by_location$pct),]

voting_by_location


```
# Voted but not Invited
```{r}
# 
voting_by_location %>% tbl_df() %>%
  summarize(total_members = sum(count), members_voted = sum(total), pct = round(100*(members_voted/total_members),0))

# anyone in voters and not in mailing_lists
mailing_list_members <- select(mailing_lists,email) %>%
  mutate(available = 1)

temp_voters <- merge(voters , mailing_list_members, by="email", all.x=TRUE) 

temp_voters %>% tbl_df() %>%
    filter( is.na(available) ) %>%
  select(email) %>%
    print()


```


# Members Who Left ION
```{r}
people_who_left <- report_df %>%
  filter( is.na(location) ) %>%
  select(email,voted) %>%
  unique()

people_who_left %>% filter(voted == 0) %>% select(email)
people_who_left %>% filter(voted == 1) %>% select(email)

```


# Participation By Area
```{r}
report_df_for_area <- report_df %>%
  select(email,area,voted,location) %>%
  filter( !is.na(location) ) %>%
  unique() %>%
  group_by(area) %>%
  summarize(count = n() , total = sum(voted), 
            pct  = round((total/count)*100,0) ) 

voting_by_area <- report_df_for_area[order(report_df_for_area$pct),]
  
print(voting_by_area)

```

# Innovators Report

```{r}
report_df_for_innovators <- report_df %>%
  select(email,area,team,innovated,location) %>%
  filter( !is.na(location) ) %>%
  unique() %>%
  group_by(area,team) %>%
  summarize(count = n() , total = sum(innovated) )  %>%
  filter (total >0 ) %>%
  arrange(area, team)

print(report_df_for_innovators)

report_df %>%
  select(email,area,team,innovated)  %>%
  filter ( innovated > 0) %>% 
  select (area, team, email ) %>%
  arrange(area, team, email)


```


